\documentclass[11pt,english,letterpaper,oneside]{article}
\usepackage{amsmath,amssymb,amsfonts,amsthm,enumerate,enumitem}
\usepackage{mathpazo}
\usepackage[margin=2.5cm]{geometry}
\usepackage{graphicx,microtype}
\usepackage{textcomp}
\usepackage[T1]{fontenc}
\DisableLigatures[f]{encoding=T1}
\usepackage[skip=2pt]{caption}
\usepackage{hyperref}
\usepackage{setspace,array,float}
\usepackage{bm,upgreek}
\usepackage[compact]{titlesec}
\usepackage[none]{hyphenat}
\setlength{\parskip}{0.25cm}
\setlength{\parindent}{0cm}
\usepackage{natbib}
\setcitestyle{citesep={;},aysep={}}
\usepackage{babel}
\usepackage{datetime}
\frenchspacing
\usepackage[table]{xcolor}
\setcounter{secnumdepth}{2}
\setcounter{tocdepth}{2}

\makeatletter
\g@addto@macro\normalsize{%
  \setlength\belowdisplayskip{15pt}
  \setlength\belowdisplayshortskip{10pt}
}
\makeatother

\renewcommand{\familydefault}{ppl}

\renewcommand\theequation{S\arabic{equation}}

\newcommand{\ppgtk}{\textit{PPGtk}}
\newcommand{\code}[1]{\hspace{15pt} \texttt{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\pagestyle{empty}


	{\huge Notes on PPGtk}
	\vspace{0.2in}
	
	Paul Blischak
	
	E-mail: \href{mailto:blischak.4@osu.edu}{blischak.4@osu.edu}
	\vspace{0.2in}
		
\tableofcontents

\newpage

\clearpage
\pagestyle{plain}
\setcounter{page}{1}



\section{Allele frequency estimation}


\subsection{The likelihood}

The likelihood of an individuals' read data given the population allele frequency can be computed by summing over the possible genotypes:

\begin{equation}
\mathcal{L}_i(p) = P(r_i|p) = \sum_{a = 0}^{m_i} P(r_i|a)P(a|p),
\end{equation}

where $P(r_i|a)$ is the genotype likelihood for genotype $a = 0,\dots,m_i$ (e.g., calculated using GATK), and 

\begin{equation*}
P(a|p) = \binom{m_i}{a}p^a (1-p)^{m_i - a}.
\end{equation*}

For multiple samples, we take the product of the individual likelihoods:

\begin{equation}
\mathcal{L}(p) = \prod_i \mathcal{L}_i(p) = \prod_i \left(\sum_{a = 0}^{m_i} P(r_i|a)P(a|p)\right).
\end{equation}

Taking the natural log gives us the log likelihood of the population allele frequency at a single site:

\begin{equation}
\ell(p) = \log \mathcal{L}(p) = \sum_i \log \left( \sum_{a= 0}^{m_i} P(r_i|a)P(a|p)\right).
\end{equation}

\subsection{Metropolis-Hastings algorithm}

\begin{equation}
P(p) \sim \text{beta}(\alpha = 0.5, \beta = 0.5).
\end{equation}

\begin{equation}
P(p|r) \propto P(r|p)P(p) = \left(\sum_a P(r|a)P(a|p)\right)P(p)
\end{equation}

\begin{equation}
\alpha = \text{min} \left\{1, \frac{P(r|p^*)P(p^*)}{P(r|p)P(p)} \right\}
\end{equation}

\subsection{Genotype estimation}

\begin{equation}
P(g_i = a|r_i) = \frac{P(r_i|g_i = a)P(g_i = a|\hat{p})}{\sum_{j=0}^{m_i}P(r_i|g_i = j)P(g_i = j|\hat{p})}
\end{equation}

\section{Disequilirium}

We introduce another parameter, $\phi$, that is related to the inbreeding coefficient ($F$) through the following equation:

\begin{equation}
F = \frac{1}{1 + \phi}
\end{equation}

\subsection{Derivative of the log beta-binomial function}

The beta function is defined as: $\mathcal{B}(\alpha,\beta) = \int_0^1 t^{(\alpha-1)}(1-t)^{(\beta-1)}\text{d}t$.



\begin{equation}
\alpha(p) = p\phi, \text{  and  } \beta(p) = (1-p)\phi\,.
\end{equation}

\begin{equation}
\frac{\partial}{\partial p} \alpha(p) = \phi\,, \text{  and  } \frac{\partial}{\partial p} \beta(p)  = -\phi\,.
\end{equation}

\begin{equation}
\frac{\partial}{\partial p} \mathcal{B}(\alpha(p), \beta(p)) = \int_0^1 \frac{\partial}{\partial p} \left\{t^{(\alpha(p)-1)}(1-t)^{(\beta(p)-1)}\right\} \text{d}t
\end{equation}

\subsection{The likelihood}

\begin{equation}
\mathcal{L}_i(p,\phi) = P(r_i|p,\phi) = \sum_{a=0}^{m_i} P(r_i|a)P(a|p,\phi)
\end{equation}



where $P(r_i|a)$ is the genotype likelihood for genotype $a = 0,\dots,m_i$ (e.g., calculated using GATK), and 

\begin{equation*}
P(a | p,\phi) = \binom{m_i}{a} \frac{\mathcal{B}(a + p\phi, m_i - a + (1 - p)\phi)}{\mathcal{B}(p\phi, (1 - p)\phi)},
\end{equation*}

which is the probability density function for the beta-binomial distribution with $n = m_i$, $k = a$, $\alpha = p\phi$, and $\beta = (1 - p)\phi$. Here, $\mathcal{B}()$ is the beta function:

\begin{equation*}
\mathcal{B}(\alpha,\beta) = \int_0^1 x^{\alpha-1} (1 - x)^{\beta - 1} \text{d}x\, .
\end{equation*}

\subsection{Metropolis-Hastings algorithm}



\section{Allopolyploid mixture model}

\begin{equation}
P(g_i = a|p_1, p_2, m_{i,1}, m_{i,2}) = \sum_{j=0}^a \sum_{r=0}^{a-j} P(g_{i,1} = j|p_1, m_{i,1})P(g_{i,2} = r | p_2, m_{i,2})\,.
\end{equation}

Here $m_{i,1} + m_{i,2} = m_i$ (e.g., 2:4 inheritance in an allopolyploid corresponds to $m_{i,1}=2$ and $m_{i,2}=4$)\,.

\begin{equation}
P(g_i = a|p_1, p_2, m_{i,1}, m_{i,2}) = \sum_{j=0}^a \left(  \sum_{r=0}^{a-j} \left[ \binom{m_{i,1}}{j} p_1^j (1 - p_1)^{m_{i,1} - j} \times \binom{m_{i,2}}{r} p_2^r (1 - p_2)^{m_{i,2} - r} \right] \right).
\end{equation}

This is a special case of the Poisson-Binomial probability distribution where we have two different probabilities of success. The most general case would be where the probability of success for every allele is different.

\begin{equation}
\mathcal{L}(p_1,p_2) = \sum_{a=0}^{m_i} \mathcal{L}(g_i = a) P(g_i = a|p_1, p_2, m_{i,1}, m_{i,2})\,.
\end{equation}

\begin{equation}
p_{\ell,k} \sim \text{Beta}(\alpha = \pi \theta_k, \beta = (1 - \pi) \theta_k), \qquad \text{where } \ell = 1,\ldots,L \text{,  and  } k = 1,2.
\end{equation}

\section{Beta mixture model}

\begin{align*}
P(g=a|p,\phi) &\sim \text{beta-binomial}(n=m_i, k = a, \alpha = p\phi, \beta = (1-p)\phi) \\
P(p|\gamma, \pi, \theta_1, \theta_2) &\sim \gamma P(p|\pi\theta_1, (1-\pi)\theta_1) + (1-\gamma)P(p|\pi\theta_2, (1-\pi)\theta_2), \\
P(\pi) &\sim \text{beta}(0.5, 0.5), \\
P(\gamma) &\sim \text{beta}(1,1), \\
P(\phi) &\sim \text{gamma}(2,0.1), \\
P(\theta_1) &\sim \text{gamma}(2,0.1), \\
P(\theta_2) &\sim \text{gamma}(2,0.1). \\
\end{align*}

\subsection{The likelihood}

\subsection{Metropolis-Hastings algorithm}

\section{Population admixture model}

\subsection{The likelihood}

\subsection{Metropolis-Hastings algorithm}



\end{document}